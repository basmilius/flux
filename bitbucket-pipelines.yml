image: node:20

clone:
  depth: 1

definitions:
  caches:
    dist: packages/*/dist

  services:
    docker:
      memory: 2048

  steps:
    - step: &build
        name: Build
        runs-on:
          - 'self.hosted'
          - 'linux'
        caches:
          - dist
          - node
          - npm
        script:
          - npm i -g pnpm
          - pnpm install
          - pnpm build

    - step: &publish
        name: Publish to registry
        runs-on:
          - 'self.hosted'
          - 'linux'
        deployment: production
        trigger: automatic
        script:
          - npm i -g pnpm
          - pnpm run publish

    - step: &sonar-scan-main
        name: SonarQube scan
        runs-on:
          - 'self.hosted'
          - 'linux'
        script:
          - pipe: sonarsource/sonarqube-scan:1.2.0
            variables:
              SONAR_HOST_URL: ${SONARQUBE_HOST}
              SONAR_TOKEN: ${SONAR_TOKEN}

    - step: &sonar-scan
        name: SonarQube scan
        runs-on:
          - 'self.hosted'
          - 'linux'
        script:
          - pipe: sonarsource/sonarqube-scan:1.2.0
            variables:
              SONAR_HOST_URL: ${SONARQUBE_HOST}
              SONAR_TOKEN: ${SONAR_TOKEN}
              EXTRA_ARGS: -Dsonar.branch.name=${BITBUCKET_BRANCH}
                -Dsonar.projectVersion=${BITBUCKET_COMMIT}

    - step: &sonar-scan-pr
        name: SonarQube scan
        runs-on:
          - 'self.hosted'
          - 'linux'
        script:
          - pipe: sonarsource/sonarqube-scan:1.2.0
            variables:
              SONAR_HOST_URL: ${SONARQUBE_HOST}
              SONAR_TOKEN: ${SONAR_TOKEN}
              EXTRA_ARGS: -Dsonar.pullrequest.key=${BITBUCKET_PR_ID}
                -Dsonar.pullrequest.branch=${BITBUCKET_BRANCH}
                -Dsonar.pullrequest.base=${BITBUCKET_PR_DESTINATION_BRANCH}

pipelines:
  branches:
    main:
      - parallel:
          - step: *build
          - step: *sonar-scan-main

    develop:
      - parallel:
          - step: *build
          - step: *sonar-scan
      - step: *publish

  pull-requests:
    '**':
      - parallel:
          - step: *build
          - step: *sonar-scan-pr
